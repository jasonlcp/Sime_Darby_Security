<template>
    <div class="page">
        <div class="navbar screencap">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="{{link}}" data-force="true" class="back link only-click-this">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">Back</span>
                    </a>
                </div>
                <div class="center">
                    <div class="title">Entry</div>
                </div>
            </div>
        </div>
        <div class="toolbar toolbar-bottom auto-height screencap">
            <div class="block">
                <div class="row">
                    <div class="col">
                        <a href="#" id="cancel_btn" class="cnc-btn color-gray button button-raised button-round button-fill ">Cancel</a>
                    </div>
                    <div class="col">
                        <a href="#" id="schedule_submit" class="ac-5 button button-raised button-round button-fill ">Share</a>
                    </div>
                 </div>
            </div>
        </div>
        <div class="page-content">
            <div class="card data-table data-table-collapsible">
                <div class="card-header">
                    <div class="data-table-title text-center qr">


                    </div>
                </div>
                <div class="card-content">
                    <table>
                        <thead>
                            <tr>
                                <th class="label-cell">Area</th>
                                <th class="label-cell">House No.</th>
                                <th class="label-cell">Visitor's Name</th>
                                <th classs="label-cell">Visitor's Registration No.</th>
                                <th class="label-cell">Visit Date</th>
                                <th class="label-cell">Entry Type</th>
                                <th class="label-cell">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#entry}}
                            <tr>
                                <td class="label-cell">{{area_name}}</td>
                                <td class="label-cell">{{lot_name}}, {{street_name}}</td>
                                <td class="label-cell">{{visitor_name}}</td>
                                <td classs="label-cell">{{visitor_car_plate}}</td>
                                <td class="label-cell">{{start_date}}</td>
                                <td class="label-cell">{{entryType entry_type}}</td>
                                <td class="label-cell stats" data-val="{{status}}">
                                    {{status}}
                                </td>
                            </tr>
                            {{/entry}}
                        </tbody>
                    </table>
                </div>
            </div>
            <br>
            <br>
        </div>
    </div>
</template>
<style scoped>
    .qr {
        width: 100%;
    }

    .qr img {
        width: 90% !important;
        height: auto !important;
    }
</style>
<script>
    import qrcode from "qrcode-generator/qrcode.js"
    export default {
        data: function () {
            var id= this.$route.params.link;
            var link;
            if(id == 1){
                link = '/';
            }else{
                link = '/visits/';
            }
            return {
                entry: null,
                link:link,
            }
        },
        on: {
            pageInit: function () {
                var self = this;
                var $$ = this.$$;
                var app = this.$app;
                var id = this.$route.params.id;
                var router = this.$router;
                this.$app.methods.getEntry(this.$route.params.id, function () {
                    var qr = qrcode(13, "M");
                    console.log(self);
                    console.log(self.entry.qr_uuid);
                    qr.addData(self.entry.qr_uuid);
                    qr.make();
                    $$(".qr").html(qr.createImgTag());
                    var dt = app.dataTable.create({
                        el: '.data-table'
                    });
                    $$('.ac-5').on('click', function () {
                        var imageLink;
                        $$('.screencap').css("display","none");
                        console.log('Calling from CapturePhoto');
                        navigator.screenshot.save(function (error, res) {
                            if (error) {
                                console.error(error);
                            } else {
                                console.log('ok', res
                                .filePath); //should be path/to/myScreenshot.jpg
                                //For android
                                imageLink = res.filePath;
                                window.plugins.socialsharing.share(null, null, 'file://' +
                                    imageLink, null);
                                $$('.screencap').css("display","block");
                                //For iOS
                                //window.plugins.socialsharing.share(null,   null,imageLink, null)
                            }
                        }, 'jpg', 50, 'myScreenShot');
                        $$('.screencap').css("display","block");
                    });
                });
                $$('.cnc-btn').on('click',function(){
                    var k = $$('.stats').data("val");
                    console.log(k);
                    if( k == 'Cancelled' || k == 'Expired' ){
                        app.dialog.alert("This entry is already cancelled or expired! ","Error!");
                    }else{
                        app.dialog.confirm('You won\'t be able to undo this.','Are you sure?',function(){
                            app.methods.updateStatusV(id,0 ,function () {
                                app.dialog.alert("Successfully cancel this entry.","Success",function(){
                                    $$(".only-click-this").click();
                                });
                            });
                        });
                    }
                });
            }
        }
    }
</script>